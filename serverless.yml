service: daily-digest
# app and org for use with dashboard.serverless.com
# app: daily-digest-app
# org: samtgarson
useDotenv: true

frameworkVersion: "2"

provider:
  name: aws
  runtime: nodejs12.x
  lambdaHashingVersion: 20201221
  region: eu-west-2
  logRetentionInDays: 3
  timeout: 10
  environment:
    MAILER_RECIPIENT: ${env:MAILER_RECIPIENT}
    MAILER_SENDER: ${env:MAILER_SENDER}
    OUTPUT_DIR: /tmp/digest-delivery
    SUPABASE_URL: ${env:SUPABASE_URL}
    SUPABASE_KEY: ${env:SUPABASE_KEY}


plugins:
  - serverless-bundle
  - serverless-plugin-optimize

package:
  individually: true

functions:
  saveArticle:
    handler: functions/save.handler
    events:
      - httpApi:
          path: /articles
          method: POST
  deliverDigest:
    handler: functions/deliver.handler
    layers:
      - arn:aws:lambda:eu-west-2:764866452798:layer:chrome-aws-lambda:20
      # - arn:aws:lambda:eu-west-2:002535286973:layer:calibre:5
      - { Ref: CalibreLambdaLayer }
    events:
      - schedule: cron(0 0 * * ? *)

layers:
  calibre:
    path: calibre

custom:
  bundle:
    sourcemaps: true
    linting: false
    forceExclude:
      - aws-sdk
      - chrome-aws-lambda
      - puppeteer-core
